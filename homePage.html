<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat App</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://images.unsplash.com/photo-1666515878427-c0a045bf03c6?crop=entropy&cs=tinysrgb&fm=jpg&ixid=MnwzMjM4NDZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2Njg3NDQ4MjM&ixlib=rb-4.0.3&q=80"
    />
    <link rel="stylesheet" type="text/css" href="css/app.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.2.3/animate.min.css"
      rel="stylesheet"
    />
    <link href="https://www.w3schools.com/w3css/4/w3.css" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="top nav">
      <div class="itm inactive">
        <i class="fa-duotone fa-question"></i> Question
      </div>
      <div class="itm active">
        <i class="fa-duotone fa-house-user"></i> Home
      </div>
      <div class="itm inactive">
        <i class="fa-duotone fa-comments"></i> Chat
      </div>
      <div class="itm inactive">
        <i class="fa-sharp fa-solid fa-magnifying-glass"></i> Information
      </div>
      <div class="itm inactive">
        <i class="fa-sharp fa-regular fa-gears"></i> Settings
      </div>
    </div>

    <main class="Question">
      <iframe id="myframe" src="/html/iframe.html"> </iframe>
    </main>

    <main class="Home">
      <div class="bar">
        <form id="home" action="/logout" method="post">
          <i class="fa-solid fa-house"></i>
          <a>Log out</a>
        </form>
        <canvas id="myCanvas" width="240" height="30">
          Your browser does not support the canvas tag.
        </canvas>
      </div>
    </main>

    <main class="Chat">
      <div id="myNav" class="overlay">
        <div class="overlay-content">
          <a href="#">Page is too small</a>
        </div>
      </div>
      <div class="bar">
        <form id="home" action="/logout" method="post">
          <i class="fa-solid fa-house"></i>
          <a>Log out</a>
        </form>

        <canvas id="myCanvas" width="240" height="30">
          Your browser does not support the canvas tag.
        </canvas>
      
        
      </div>
      <div class="flex-container">
        <div class="inputs">
          <p class="roomNameId" style="font-size: 18px">room: ?</p>
          <ul class="chat"></ul>
          <textarea
            style="overflow: auto; resize: none"
            class="messageBar"
            rows="10"
            cols="40"
          ></textarea>
          <button class="send">
            <i class="fa-sharp fa-solid fa-paper-plane-top"></i>
          </button>
        </div>
        <div class="table">
          <table id="allContentPeople"></table>
        </div>
      </div>
    </main>

    <main class="Information"></main>


    <main class="Settings">

     
        <input type="hidden"  class='username changeU' required/>
        <br>
        <input type="text" class='password changeP' required/>
        <br>
        <div id='form'> </div>
        <input type="submit" id="submit"/>

        <hr/>

        <input type="hidden"  class='username deleteU' required/>
        <br>
        <input type="text" class='password deleteP' required/>
        <br>
        <input type="submit" id="submitD" value="delet my account"/>





    </main>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
      src="https://kit.fontawesome.com/fd76b8450f.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mouse0270-bootstrap-notify/3.1.5/bootstrap-notify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script src="/js/welcolm.js"></script>
    <script src="/js/markdown.js"></script>
    <script src="/js/socket.js"></script>
    <script>
      
      document.querySelectorAll("main").forEach((item) => {
        item.style.display = "none";
      });

      document.querySelector(".Home").style.display = "block";

      welcolm(username);
      chatWelcolm(username)

      //
      var o = ["Question", "Home", "Chat", "Information", "Settings"];

      document.querySelectorAll(".itm").forEach((item) => {
        item.addEventListener("click", function () {
          let clicked = this.innerText.trim();

          document.querySelectorAll(".itm").forEach(function (x) {
            if (x.innerText.trim() == clicked) {
              x.classList.replace("inactive", "active");
            } else {
              x.classList.replace("active", "inactive");
            }
          });

          document.querySelectorAll("main").forEach((item) => {
            if (item.className == this.innerText.trim()) {
              item.style.display = "block";
            } else {
              item.style.display = "none";
            }
          });

          switch (this.innerText.trim()) {
            case "Information":
              getMarkdown()
                .then((data) => {
                  document.querySelector(".Information").innerHTML =
                    getMarkdownText(data);
                })
                .catch((e) => {
                  console.error(e);
                  document.querySelector(".Information").innerHTML =
                    "failed! " + e;
                });
              break;
            case "Chats":
              break;
            case "Home":
              break;
            case "How to":
              break;
            case "Settings":
              break;
            default:
              break;
          }
        });
      });
    </script>


<script>
  
  function deleteAccount(username, password) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/remove",
      data: {
        username: username,
        password: password,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}

function validate(username, password) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/validate",
      data: {
        username: username,
        password: password,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}

function updateUsername(username, password, new_username) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/change",
      data: {
        curr_username: username,
        curr_password: password,
        new_username: new_username,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}

function reset(input) {
  usernameC.value = username;
  passwordC.value = "";

  usernameC.removeAttribute("disabled");
  passwordC.removeAttribute("disabled");

  document.getElementById("hi212").remove();

  submit.addEventListener("click", update);
}

async function update(e) {
    e.preventDefault(); 
  let v = await validate(usernameC.value, passwordC.value);

  if (v.valid) {
    usernameC.setAttribute("disabled", "true");
    passwordC.setAttribute("disabled", "true");

    let input = document.createElement("input");
    input.setAttribute("type", "text");
    input.setAttribute("class", "newU");
    input.setAttribute("placeholder", "Please enter a new username");
    input.id = "hi212";
    document.querySelector("#form").appendChild(input);

    submit.removeEventListener("click", update);

    input.addEventListener("keyup", function (e) {
        e.preventDefault(); 
      if (e.target.value.length > 0 && e.target.value.trim().length > 0) {
        submit.addEventListener("click", async function (e) {
          e.preventDefault(); 
          if (usernameC.value == input.value) {
            
            alert("the new username is the same as the old one");
            reset();

            window.location.reload();
          }
          let res = await updateUsername(
            usernameC.value,
            passwordC.value,
            input.value
          );
          if (typeof res.error == "string") {
            alert(res.error);

            reset();

            window.location.reload();
          } else {
            alert("your username is now changed");

            //logout and re-login
            window.location.reload();
          }
        });
      }
    });
  }
}




 // delete yor account 

 
 const deleteU = document.querySelector('.deleteU')
   const deleteP = document.querySelector('.deleteP')
 const button = document.querySelector('#submitD')
 
 deleteU.value  = username
 
 
 button.addEventListener('click',async function(event){
  event.preventDefault(); 

  let v = await validate(deleteU.value, deleteP.value)
 
  console.log( 
    `
     ${v.valid} == false 
    `
   )


   if( v.valid === false && v.valid  !== undefined ){
     alert('Please enter a valid password')
   }else{

     let e = window.prompt('are you sure you want to delete this account? this is a permanant action. Type Delete to complete this action!')
 
     if(e.trim() == 'Delete'){
       deleteAccount( deleteU.value, deleteP.value ).then(function(e){
         if(e.res){
           document.querySelectorAll('#home')[0].click();
         }else{
           alert('there was a problem deleting this account')
         }
       })
     }
   }
 
 
 })
 


 //update you username
 const usernameC = document.querySelector(".changeU")
  const passwordC = document.querySelector(".changeP")
  const submit = document.querySelector("#submit")
 
  usernameC.value  = username
 
 
 submit.addEventListener("click",update)
</script>


  </body>
</html>
