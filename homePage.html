<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Chat App</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://images.unsplash.com/photo-1666515878427-c0a045bf03c6?crop=entropy&cs=tinysrgb&fm=jpg&ixid=MnwzMjM4NDZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE2Njg3NDQ4MjM&ixlib=rb-4.0.3&q=80"
    />
    <link rel="stylesheet" type="text/css" href="css/app.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.2.3/animate.min.css"
      rel="stylesheet"
    />
    <link href="https://www.w3schools.com/w3css/4/w3.css" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="top nav">
      <div class="itm inactive">
        <i class="fa-duotone fa-question"></i> Question
      </div>
      <div class="itm active">
        <i class="fa-duotone fa-house-user"></i> Home
      </div>
      <div class="itm inactive">
        <i class="fa-duotone fa-comments"></i> Chat
      </div>
      <div class="itm inactive">
        <i class="fa-sharp fa-solid fa-magnifying-glass"></i> Information
      </div>
      <div class="itm inactive">
        <i class="fa-sharp fa-regular fa-gears"></i> Settings
      </div>
    </div>

    <main class="Question">
      <iframe id="myframe" src="/html/iframe.html"> </iframe>
    </main>

    <main class="Home">
      <div class="bar">
        <form id="home" action="/logout" method="post">
          <i class="fa-solid fa-house"></i>
          <a>Log out</a>
        </form>
        <canvas id="myCanvas" width="240" height="30">
          Your browser does not support the canvas tag.
        </canvas>
      </div>
    </main>

    <main class="Chat">
      <div id="myNav" class="overlay">
        <div class="overlay-content">
          <a href="#">Page is too small</a>
        </div>
      </div>
      <div class="bar">
        <form id="home" action="/logout" method="post">
          <i class="fa-solid fa-house"></i>
          <a>Log out</a>
        </form>

        <canvas id="myCanvas" width="240" height="30">
          Your browser does not support the canvas tag.
        </canvas>
      
        
      </div>
      <div class="flex-container">
        <div class="inputs">
          <p class="roomNameId" style="font-size: 18px">room: ?</p>
          <ul class="chat"></ul>
          <textarea
            style="overflow: auto; resize: none"
            class="messageBar"
            rows="10"
            cols="40"
          ></textarea>
          <button class="send">
            <i class="fa-sharp fa-solid fa-paper-plane-top"></i>
          </button>
        </div>
        <div class="table">
          <table id="allContentPeople"></table>
        </div>
      </div>
    </main>

    <main class="Information"></main>


    <main class="Settings">

     
      <h3 style="text-align:center">change user name</h3>

        <label for="username">Your password</label>
        <input type="text" class='password changeP' required/>
        <br>
        <label for="N-username">new username</label>
        <input type="text" class="N-username" required disabled/>
        <br>
        <input type="submit" id="submit" value="check my account"/>

        <hr/>

      

        <h3 style="text-align:center">change password</h3>
    
        <label for="username">Your password</label>
        <input type="text" class='password changePP' required/>
        <br>
        <label for="N-username">new password</label>
        <input type="text" class="N-password" required disabled/>
        <br>
        <input type="submit" id="submit1" value="check my account"/>

        <hr/>

        <h3 style="text-align:center">Delete your account</h3>

         <label for="username">Your password</label>
        <input type="text" class='password deleteP' required/>
        <br>
        <input type="submit" id="submitD" value="delet my account"/>

        




    </main>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
      src="https://kit.fontawesome.com/fd76b8450f.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mouse0270-bootstrap-notify/3.1.5/bootstrap-notify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script src="/js/welcolm.js"></script>
    <script src="/js/markdown.js"></script>
    <script src="/js/socket.js"></script>
    <script>
      
      document.querySelectorAll("main").forEach((item) => {
        item.style.display = "none";
      });

      document.querySelector(".Home").style.display = "block";

      welcolm(username);
      chatWelcolm(username)

      //
      var o = ["Question", "Home", "Chat", "Information", "Settings"];

      document.querySelectorAll(".itm").forEach((item) => {
        item.addEventListener("click", function () {
          let clicked = this.innerText.trim();

          document.querySelectorAll(".itm").forEach(function (x) {
            if (x.innerText.trim() == clicked) {
              x.classList.replace("inactive", "active");
            } else {
              x.classList.replace("active", "inactive");
            }
          });

          document.querySelectorAll("main").forEach((item) => {
            if (item.className == this.innerText.trim()) {
              item.style.display = "block";
            } else {
              item.style.display = "none";
            }
          });

          switch (this.innerText.trim()) {
            case "Information":
              getMarkdown()
                .then((data) => {
                  document.querySelector(".Information").innerHTML =
                    getMarkdownText(data);
                })
                .catch((e) => {
                  console.error(e);
                  document.querySelector(".Information").innerHTML =
                    "failed! " + e;
                });
              break;
            case "Chats":
              break;
            case "Home":
              break;
            case "How to":
              break;
            case "Settings":
              break;
            default:
              break;
          }
        });
      });
    </script>


<script>
   async function removeAccount (event){
  event.preventDefault(); 

  let v = await validate(deleteU.value, deleteP.value)
 


   if( v.valid === false && v.valid  !== undefined ){
     alert('Please enter a valid password')
   }else{

     let e = window.prompt('are you sure you want to delete this account? this is a permanant action. Type Delete to complete this action!')
 
     if(e.trim() == 'Delete'){
       deleteAccount( deleteU.value, deleteP.value ).then(function(e){
         if(e.res){        
        //  updateUsername(deleteU.value, deleteP.value, 'delete').then(function(e){
            document.querySelectorAll('#home')[0].click();
        //  })
           
         }else{
           alert('there was a problem deleting this account')
         }
       })
     }
   }
  }
 

  function deleteAccount(username, password) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/remove",
      data: {
        username: username,
        password: password,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}

function validate(username, password) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/validate",
      data: {
        username: username,
        password: password,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}

function updateUsername(username, password, new_username) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/changeUsername",
      data: {
        curr_username: username,
        curr_password: password,
        new_username: new_username,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}

function updatePassword(username, password, new_password) {
  return new Promise((resolve, reject) => {
    $.ajax({
      type: "post",
      url: "http://localhost:3000/api/account/changePassword",
      data: {
        curr_username: username,
        curr_password: password,
        new_password: new_password,
      },
      success: function (e) {
        resolve(e);
      },
    });
  });
}


function reset() {
  usernameC.value = username;
  passwordC.value = "";

  N_username.setAttribute("disabled",true);
  passwordC.removeAttribute('disabled')

  submit.addEventListener("click", update);

}

function resetA() {
  usernameP.value = username;
  passwordP.value = "";

  N_password.setAttribute("disabled",true);
  passwordP.removeAttribute('disabled')

  submit1.addEventListener("click", resetA);

}


async function updateA(e){
  if(N_password.value.trim().length > 0){
    if(!(passwordP.value == N_password.value)  ){
      let a = window.confirm('are you sure you want to reset your password')

      if(a){
      updatePassword(usernameP.value, passwordP.value, N_password.value).then(function(){
        alert('your account is updated')
      }).then(function(){
        resetA()
        window.location.reload()

      })
    }
    }else{

      
    }
  }
}


async function update(e){
  if(N_username.value.trim().length > 0){
    let v = await validate(N_username.value, passwordC.value);


    if(v.valid && !(usernameC.value == N_username.value)  ){
      updateUsername(usernameC.value, passwordC.value, N_username.value).then(function(){
        alert('your account is updated')
      }).then(function(){
        reset()

        socket.emit('logedin', N_username.value)
        socket.username = N_username.value
        window.location.reload()

      })
    }else{
      !v.valid ? alert('Please enter a new valid username that dose not already exist') : (usernameC.value == N_username.value) ? alert("please enter a new username") : null;
    }
  }
}

async function valUpdate(e) {
    e.preventDefault(); 
  let v = await validate(usernameC.value, passwordC.value);

  if ( v.valid === true && v.valid  !== undefined  ) {
    N_username.removeAttribute('disabled')
    submit.value = 'submit'
    passwordC.setAttribute('disabled',true)

    submit.removeEventListener('click',valUpdate)
    submit.addEventListener('click',update)


}

}


async function pwdUpdate(e) {
  e.preventDefault(); 


  if(passwordP.value.trim().length > 0){
    let v = await validate(usernameP.value, passwordP.value);

    N_password.removeAttribute('disabled')
    submit1.value = 'submit'
    passwordP.setAttribute('disabled',true)

submit1.removeEventListener('click', pwdUpdate)

submit1.addEventListener('click',updateA)
  }
}

 // delete yor account 

 
 const deleteU =  {value: username}
   const deleteP = document.querySelector('.deleteP')
 const button = document.querySelector('#submitD')
 
 deleteU.value  = username
 
 
 button.addEventListener('click',removeAccount)
 

 


 //update you username
 const usernameC =  {value: username}
  const passwordC = document.querySelector(".changeP")
  const N_username = document.querySelector(".N-username")

  const submit = document.querySelector("#submit")
 
  usernameC.value  = username
 

 submit.addEventListener("click",valUpdate)


 //update password

 const usernameP =  {value: username}
  const passwordP = document.querySelector(".changePP")
  const N_password = document.querySelector(".N-password")

  const submit1 = document.querySelector("#submit1")
 
 

 submit1.addEventListener("click",pwdUpdate)



</script>


  </body>
</html>
