<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://kit.fontawesome.com/fd76b8450f.js" crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub.min.js"></script>
<body>
	<div class='bar'>
		<form id='home' action='/home' method="get">
			<i class="fa-solid fa-house" ></i>
			<a>Log out</a>
		</form>
	</div>
	<div id="info">
		<input id='Name'></input>
		<button id="setname" onclick="set_name(document.getElementById('Name').value )">Name</button>
	</div>
	<div id="all">
		<br>
		<div id="inputs">
			<input id="login" readonly></input>
			<button id="host"  onclick="host()">host</button>
			<br>
			<input id="joins" required></input>
			<button id="join" >join</button>
		</div>
		<p class="presence"></p>
		<div id="users"></div>
		<lable for'box' id='boxTXT'>Chat Output</lable>
		<div id="box" ></div>
		Enter Chat and press enter
		<div><input id="input" placeholder="type message here" /></div>
	</div>
</body>
<script>
 home = document.getElementById('home')

	home.addEventListener('click',function(params) {
		home.submit()
	})


	function generatePass(pLength){
	       charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
	       retVal = "";
	   for (var i = 0, n = charset.length; i < pLength; ++i) {
	       retVal += charset.charAt(Math.floor(Math.random() * n));
	   }
	   return retVal;

	}

</script>
<script>
// times out after 100,000 seconds or 1.66667 minits
	 time_out_time = 100000
	//resets time out after window activity
	window.addEventListener('click',reset_time_out);
	window.addEventListener('mousemove',reset_time_out);
	window.addEventListener('keydown',reset_time_out);
	//times out if there is no name assigned to the account
	setTimeout(function(){
	    if(document.getElementById('Name').value == ''){
	        time_out()
	    }

	},3000)

	var myTimeout = setTimeout(time_out, time_out_time);

	function time_out() {
	sessionStorage.removeItem("passwordIn");

	 home.click()
	}

	function reset_time_out(){
	      clearTimeout(myTimeout);
	       myTimeout = setTimeout(time_out, time_out_time)
	}

</script>
<style>
	@import "https://fonts.googleapis.com/icon?family=Material+Icons";
	body {
	font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
	}
	#box {
	border: 2px solid #efefef;
	width: 700px;
	height: 80%;
	overflow-y: auto;
	margin-bottom: 20px;
	position: absolute;
	top: 40px;
	left: 400px;
	}
	.avatar {
	width: 80px;
	height: 80px;
	border-radius: 40px; 
	margin: 10px;
	}
	#input {
	position: absolute;
	top: 20px;
	left: 400px;
	}
	#boxTXT {
	position: absolute;
	top: 0;
	left: 400px;
	}
	input {
	width: 300px;
	}
	button {
	width: 70px;
	}
	* {
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
	box-sizing: border-box;
	}
</style>
<script type = "text/javascript">
	var socket = io();

	// this will ask the client who they are
	socket.on('whoAreyou', function(msg) {

	$('#Name').val(msg)
	$('#setname').click()

	try{
	console.log( msg )
	}catch(e){
	console.log('the chat will not work until you login')
	}
	socket.off('whoAreyou');
	})


</script>
<script type = "text/javascript">
 function roomThing(room){
	  	    document.getElementById('joins').value = room

	  	    //$('#join').click()

	}

function delet_roomThing(room){
    Swal.fire({
  title: 'Do you realy want to remove this room',
  showDenyButton: true,
  showCancelButton: false,
  confirmButtonText: 'remove',
  denyButtonText: `Don't remove`,
}).then((result) => {
  /* Read more about isConfirmed, isDenied below */
  if (result.isConfirmed) {
    Swal.fire('Deleted!', '', 'success')

       sessionStorage.removeItem(room)
      document.getElementById(room).remove()
      set_roomsTable()

  } else if (result.isDenied) {
    Swal.fire('Room is save', '', 'success')
  }
})


}


$('#join').on('click',function(){
    join(document.getElementById('joins').value,true )
})

function loadALL() {
    return {...sessionStorage}
}


// formats the time
Date.prototype.toFormat = function(){
    let r = this.toISOString().split('T')[0].replace(/-/g,'/').split('/')
    let data = (this.getHours() > 12 ? 'PM '+(this.getHours()-12) : 'AM '+this.getHours())   +':'+ this.getMinutes();
    data = data.split(':')[0] +':'+ (data.split(':')[1].length === 1 ? '0'+data.split(':')[1] : data.split(':')[1])

    let a =  r[2] +'/'+r[1]+'/'+r[0] +' '+  data

    return a;

}

	var names,
	presence = document.querySelector('.presence');

	$("#all").hide()

	$("#setname").click(function(){
	  if( $("#Name").val().trim().length == 0 ){

	  }else{
	    $("#info").hide('slow',function(){
	      $("#info").hide()
	    })
	    $("#all").show()

	  }
	})



	 function set_name(a){
	   names = a
	}

	// hosts the room
	function host(){
	    $('#joins').val('')
	           socket.removeAllListeners( $("#login").val() )


	    if($("#login").val() != '' && $('#joins').val() != ''){
	        $('#joins').val('')
	    }

	            $("#login").val('')


	  $("#login").val(generatePass(9) )


	  join(  $("#login").val(),false )




	}

	// Get the input field
	var input = $("#input");
var i = 0
// alows you to join the room
// if it is the first time then the join seqence is diffrent
	function join(e,first){
	     if($("#login").val() != '' && $('#joins').val() != ''){
	        $('#login').val('')
	    }

	    	sessionStorage.setItem(e,i);

	    	i++

	    	set_roomsTable()

		box.innerHTML = ''
		socket.emit('persistence',e)

		socket.on('persistence',function (params) {

		socket.off('persistence')

        params.filter(res => {
		var {message_id,messageCode,message,who} = res

		return messageCode == e
	}).map( (x,index) =>{
		var {message_id,messageCode,message,who,date} = x
		if(index == 0){
		box.innerHTML +=  `${who} : ${message} : ${date}`
		}else{
		box.innerHTML +=  `<br>${who} : ${message} : ${date}`
		}
			})


	if( first ){
	     if($("#login").val() != '' && $('#joins').val() != ''){
	        $('#login').val('')
	    }
	}
	  socket.emit('room name',e)

	// Execute a function when the user presses a key on the keyboard
	input.on("keypress", function(event) {
	  // If the user presses the "Enter" key on the keyboard
	  if (event.key === "Enter") {
	    // Cancel the default action, if needed
	    event.preventDefault();
	    // Trigger the button element with a click
	    var is = e == $("#login").val() ^ e == $('#joins').val()
	    if( is != 1 ) return;
	     socket.emit('chat message',event.target.value ,e)
	  }
	});



	socket.on(e, function(text){
	//    if( text.split(' :')[0] !=  e ) return
	    if( box.innerHTML == ''){
	         box.innerHTML =  (''+text).replace( /[<>]/g, '' )
	    }else{
	         box.innerHTML = box.innerHTML + "<br>"+ (''+text).replace( /[<>]/g, '' )
	    }
	  input.val('')
	})

			})
	}


	function add_row(room){
var tr = document.createElement('tr')

tr.id = room

tda = document.createElement('td')
tda.innerHTML = `<a>${room}</a>`
tr.append(tda)

tdb = document.createElement('td')
let btna = document.createElement('button')
btna.innerHTML = 'open'
btna.className = 'open'
btna.addEventListener('click',function(){
    roomThing(room)
    document.getElementById('join').click()
})
tdb.append(btna)
tr.append(tdb)


tdc = document.createElement('td')
let btnb = document.createElement('button')
btnb.innerHTML = 'delet'
btnb.className = 'delet'
btnb.addEventListener('click',function(){
    delet_roomThing(room)
})
tdc.append(btnb)
tr.append(tdc)





 document.querySelector('table').append(tr)
}

function set_roomsTable(){
     document.querySelector('table').innerHTML = ''
Object.entries(loadALL()).map(x => {
    add_row( x[0] )
})
}

</script>


<table>

</table>


<style>
    table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: auto;
}

td, th {
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}


table button {
  background-color: Transparent;
background-repeat:no-repeat;
border: none;
}

.open {
  background-color: #64DD17;
}

.delet {
  background-color: #D50000;
}
</style>
<script>


set_roomsTable();

/*
$('table').find('tr').click( function(){
    this.click()


    var place =  ($(this).index())
    let open = [...document.querySelectorAll('.open')][place]
    let delet = [...document.querySelectorAll('.delet')][place]
    let key = [...document.querySelectorAll('tr')][place]


    open.addEventListener('click',function(){
         console.log(this)
   roomThing( $($(key).find('td')[0]).find('a')[0].innerText   )
  }) 

  delet.addEventListener('click',function(){
       console.log(this)
   delet_roomThing( $($(key).find('td')[0]).find('a')[0].innerText, place )
  }) 

});
*/

</script>
